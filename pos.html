<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ShadowShop ‚Äî POS</title>
<link href="https://fonts.googleapis.com/css2?family=VT323&family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --dirt: #8B6914;
  --dirt-dark: #5C4A1E;
  --grass: #5D9E3F;
  --grass-dark: #3A6B28;
  --stone: #8A8A8A;
  --stone-dark: #5A5A5A;
  --wood: #9C7A3C;
  --wood-dark: #6B5228;
  --emerald: #17DD62;
  --emerald-dark: #0DA048;
  --emerald-glow: rgba(23,221,98,0.3);
  --diamond: #4FD0D0;
  --gold: #FFCC00;
  --redstone: #CC2222;
  --bg: #1a1a1a;
  --panel: #2D2D2D;
  --panel2: #3A3A3A;
  --text: #FFFFFF;
  --text-dim: #AAAAAA;
}

body {
  font-family: 'VT323', monospace;
  background: var(--bg);
  color: var(--text);
  height: 100vh;
  overflow: hidden;
  image-rendering: pixelated;
  display: flex;
  flex-direction: column;
}

body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image:
    linear-gradient(rgba(0,0,0,0.5) 1px, transparent 1px),
    linear-gradient(90deg, rgba(0,0,0,0.5) 1px, transparent 1px);
  background-size: 32px 32px;
  pointer-events: none;
  z-index: 0;
}

/* TOPBAR */
.topbar {
  background: linear-gradient(180deg, #4a7a2e 0%, var(--grass-dark) 60%, var(--dirt) 100%);
  border-bottom: 4px solid #000;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 24px;
  height: 56px;
  flex-shrink: 0;
  box-shadow: 0 4px 0 #000;
  position: relative;
  z-index: 10;
}

.topbar::after {
  content: '';
  position: absolute;
  bottom: -8px; left: 0; right: 0;
  height: 4px;
  background: var(--dirt-dark);
}

.topbar-brand {
  font-family: 'Press Start 2P', monospace;
  font-size: 13px;
  color: var(--gold);
  text-shadow: 2px 2px 0 #000;
}

.topbar-info {
  display: flex;
  align-items: center;
  gap: 20px;
}

.topbar-info span {
  font-size: 18px;
  color: rgba(255,255,255,0.8);
}

.cashier-badge {
  background: var(--emerald-dark);
  border: 2px solid #000;
  color: white;
  font-family: 'Press Start 2P', monospace;
  font-size: 9px;
  padding: 5px 10px;
  text-shadow: 1px 1px 0 #000;
  box-shadow: 2px 2px 0 #000;
}

/* MAIN */
.main {
  display: grid;
  grid-template-columns: 1fr 380px;
  flex: 1;
  overflow: hidden;
  position: relative;
  z-index: 1;
}

/* PRODUCTS */
.products-panel {
  display: flex;
  flex-direction: column;
  overflow: hidden;
  padding: 16px 20px;
  gap: 12px;
}

.search-bar { position: relative; }

.search-bar input {
  width: 100%;
  padding: 10px 14px 10px 40px;
  background: #111;
  border: 3px solid var(--stone-dark);
  outline: 2px solid #000;
  color: white;
  font-family: 'VT323', monospace;
  font-size: 20px;
  transition: border-color 0.15s;
}

.search-bar input:focus {
  border-color: var(--emerald);
  box-shadow: 0 0 8px var(--emerald-glow);
  outline: 2px solid #000;
}

.search-bar input::placeholder { color: #555; }

.search-bar svg {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: #666;
}

.category-tabs {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}

.tab {
  padding: 6px 14px;
  font-family: 'VT323', monospace;
  font-size: 17px;
  cursor: pointer;
  background: var(--stone-dark);
  border: 2px solid #000;
  color: var(--text-dim);
  transition: all 0.1s steps(1);
  user-select: none;
  outline: 1px solid rgba(255,255,255,0.1);
}

.tab:hover { background: var(--stone); color: white; }
.tab.active {
  background: linear-gradient(180deg, #6aad3f, var(--grass-dark));
  color: white;
  text-shadow: 1px 1px 0 #000;
  box-shadow: 0 3px 0 #000;
}

.product-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 10px;
  overflow-y: auto;
  padding-right: 4px;
  padding-bottom: 4px;
}

.product-grid::-webkit-scrollbar { width: 8px; }
.product-grid::-webkit-scrollbar-track { background: #111; }
.product-grid::-webkit-scrollbar-thumb { background: var(--stone-dark); border: 2px solid #000; }

.product-card {
  background: var(--panel2);
  border: 3px solid var(--stone-dark);
  outline: 2px solid #000;
  padding: 12px 10px;
  cursor: pointer;
  transition: all 0.1s steps(1);
  display: flex;
  flex-direction: column;
  gap: 6px;
  box-shadow: 3px 3px 0 #000;
}

.product-card:hover {
  border-color: var(--emerald);
  background: #444;
  transform: translate(-2px,-2px);
  box-shadow: 5px 5px 0 #000;
}

.product-card:active {
  transform: translate(1px,1px);
  box-shadow: 1px 1px 0 #000;
}

.product-emoji {
  font-size: 32px;
  line-height: 1;
  text-align: center;
  filter: drop-shadow(1px 1px 0 rgba(0,0,0,0.8));
}

.product-name {
  font-family: 'Press Start 2P', monospace;
  font-size: 8px;
  line-height: 1.5;
  color: white;
  text-shadow: 1px 1px 0 #000;
  word-break: break-word;
}

.product-sku { font-size: 14px; color: #888; }

.product-price {
  font-family: 'Press Start 2P', monospace;
  font-size: 10px;
  color: var(--emerald);
  text-shadow: 1px 1px 0 #000;
  margin-top: auto;
}

/* CART */
.cart-panel {
  background: var(--panel);
  border-left: 4px solid #000;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  box-shadow: inset 2px 0 0 rgba(255,255,255,0.03);
}

.cart-header {
  padding: 14px 18px 12px;
  border-bottom: 3px solid #000;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-shrink: 0;
  background: var(--stone-dark);
}

.cart-title {
  font-family: 'Press Start 2P', monospace;
  font-size: 11px;
  color: var(--gold);
  text-shadow: 1px 1px 0 #000;
}

.cart-count {
  background: var(--redstone);
  border: 2px solid #000;
  color: white;
  font-family: 'Press Start 2P', monospace;
  font-size: 10px;
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 2px 2px 0 #000;
}

.customer-row {
  padding: 10px 16px;
  border-bottom: 2px solid #000;
  flex-shrink: 0;
  background: rgba(0,0,0,0.2);
}

.mc-input {
  width: 100%;
  padding: 8px 12px;
  background: #1a1a1a;
  border: 3px solid var(--stone-dark);
  outline: 2px solid #000;
  color: white;
  font-family: 'VT323', monospace;
  font-size: 17px;
  transition: border-color 0.15s;
}

.mc-input:focus {
  outline: 2px solid #000;
  border-color: var(--emerald);
  box-shadow: 0 0 0 1px var(--emerald-dark), 0 0 8px var(--emerald-glow);
}

.mc-input::placeholder { color: #555; }

.cart-items {
  flex: 1;
  overflow-y: auto;
  padding: 10px 16px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.cart-items::-webkit-scrollbar { width: 6px; }
.cart-items::-webkit-scrollbar-track { background: #1a1a1a; }
.cart-items::-webkit-scrollbar-thumb { background: var(--stone-dark); border: 1px solid #000; }

.cart-empty {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 8px;
  color: #555;
}

.cart-empty-icon { font-size: 40px; opacity: 0.5; }
.cart-empty p { font-family: 'Press Start 2P', monospace; font-size: 9px; text-align: center; line-height: 1.8; }

.cart-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 10px;
  background: #222;
  border: 2px solid var(--stone-dark);
  outline: 1px solid #000;
  animation: slideIn 0.15s steps(3) forwards;
}

@keyframes slideIn {
  from { opacity: 0; transform: translateX(10px); }
  to   { opacity: 1; transform: translateX(0); }
}

.cart-item-emoji { font-size: 20px; flex-shrink: 0; }
.cart-item-info { flex: 1; min-width: 0; }

.cart-item-name {
  font-family: 'Press Start 2P', monospace;
  font-size: 7px;
  line-height: 1.6;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.cart-item-price { font-size: 14px; color: #888; }

.cart-item-controls { display: flex; align-items: center; gap: 4px; }

.qty-btn {
  width: 22px;
  height: 22px;
  background: var(--stone-dark);
  border: 2px solid #000;
  cursor: pointer;
  font-size: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 900;
  color: white;
  font-family: 'VT323', monospace;
  line-height: 1;
  transition: all 0.1s steps(1);
}

.qty-btn:hover { background: var(--emerald-dark); }
.qty-btn:active { transform: scale(0.9); }

.qty-display {
  font-family: 'Press Start 2P', monospace;
  font-size: 10px;
  min-width: 18px;
  text-align: center;
}

.cart-item-total {
  font-family: 'Press Start 2P', monospace;
  font-size: 8px;
  color: var(--emerald);
  min-width: 44px;
  text-align: right;
}

.remove-btn {
  background: none;
  border: none;
  cursor: pointer;
  color: #666;
  font-size: 16px;
  padding: 2px;
  font-family: 'VT323', monospace;
  transition: color 0.1s steps(1);
  line-height: 1;
}

.remove-btn:hover { color: var(--redstone); }

.cart-totals {
  padding: 12px 16px;
  border-top: 3px solid #000;
  display: flex;
  flex-direction: column;
  gap: 6px;
  flex-shrink: 0;
  background: rgba(0,0,0,0.3);
}

.totals-row {
  display: flex;
  justify-content: space-between;
  font-size: 17px;
  color: var(--text-dim);
}

.totals-row.discount { color: var(--emerald); }

.totals-divider {
  border: none;
  border-top: 2px solid var(--stone-dark);
  margin: 2px 0;
}

.totals-row.total {
  font-family: 'Press Start 2P', monospace;
  font-size: 11px;
  color: var(--gold);
  text-shadow: 1px 1px 0 #000;
}

.discount-row {
  display: flex;
  gap: 6px;
  padding: 8px 16px 0;
  flex-shrink: 0;
}

.discount-input {
  flex: 1;
  padding: 7px 10px;
  background: #111;
  border: 2px solid var(--stone-dark);
  outline: 1px solid #000;
  font-family: 'VT323', monospace;
  font-size: 18px;
  color: white;
}

.discount-input:focus { border-color: var(--emerald); outline: 1px solid #000; }
.discount-input::placeholder { color: #555; }

.btn-discount {
  padding: 7px 12px;
  background: linear-gradient(180deg, #8c6d2f, var(--wood-dark, #6B5228));
  border: 2px solid #000;
  color: var(--gold);
  font-family: 'Press Start 2P', monospace;
  font-size: 8px;
  cursor: pointer;
  text-shadow: 1px 1px 0 #000;
  box-shadow: 2px 2px 0 #000;
  transition: all 0.1s steps(1);
}

.btn-discount:hover { background: linear-gradient(180deg, #a07d36, #8c6d2f); }
.btn-discount:active { transform: translate(2px,2px); box-shadow: 0 0 0 #000; }

.pay-section {
  padding: 10px 16px 16px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  flex-shrink: 0;
}

.btn-charge {
  width: 100%;
  padding: 14px;
  background: linear-gradient(180deg, #1fee6a 0%, var(--emerald-dark) 100%);
  border: 3px solid #000;
  color: #003a15;
  font-family: 'Press Start 2P', monospace;
  font-size: 10px;
  cursor: pointer;
  text-shadow: 0 1px 0 rgba(255,255,255,0.3);
  box-shadow: 0 5px 0 #056030, 4px 0 0 rgba(0,0,0,0.3);
  transition: all 0.1s steps(1);
  letter-spacing: 0.03em;
}

.btn-charge:hover {
  background: linear-gradient(180deg, #34ff7c 0%, #0fbe52 100%);
  transform: translateY(-2px);
  box-shadow: 0 7px 0 #056030, 4px 0 0 rgba(0,0,0,0.3);
}

.btn-charge:active {
  transform: translateY(4px);
  box-shadow: 0 0 0 #056030, 0 0 0 rgba(0,0,0,0.3);
}

.btn-charge:disabled {
  background: var(--stone-dark);
  color: #666;
  cursor: not-allowed;
  transform: none;
  box-shadow: 0 3px 0 #333;
  text-shadow: none;
}

/* TOASTS */
.toast {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%) translateY(40px);
  background: var(--emerald-dark);
  border: 2px solid #000;
  color: white;
  font-family: 'Press Start 2P', monospace;
  font-size: 9px;
  padding: 8px 16px;
  box-shadow: 4px 4px 0 #000;
  opacity: 0;
  transition: all 0.2s steps(3);
  z-index: 200;
  pointer-events: none;
}

.toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

.vip-toast {
  position: fixed;
  top: 72px;
  right: -360px;
  z-index: 300;
  pointer-events: none;
  display: flex;
  align-items: stretch;
  filter: drop-shadow(4px 4px 0 #000);
  transition: right 0.18s steps(6);
}

.vip-toast.show { right: 16px; }

.vip-toast-icon {
  width: 52px;
  background: #1a1a1a;
  border: 3px solid #000;
  border-right: 2px solid #333;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  flex-shrink: 0;
}

.vip-toast-body {
  background: #1a1a1a;
  border: 3px solid #000;
  border-left: none;
  padding: 8px 14px 10px;
  min-width: 220px;
  position: relative;
  overflow: hidden;
}

.vip-toast-title {
  font-family: 'Press Start 2P', monospace;
  font-size: 7px;
  color: var(--gold);
  text-shadow: 1px 1px 0 #000;
  margin-bottom: 5px;
  letter-spacing: 0.04em;
}

.vip-toast-msg {
  font-family: 'Press Start 2P', monospace;
  font-size: 8px;
  color: var(--emerald);
  text-shadow: 1px 1px 0 #000;
  line-height: 1.7;
}

.vip-toast-bar {
  position: absolute;
  bottom: 0; left: 0; right: 0;
  height: 3px;
  background: var(--gold);
  transform-origin: left;
}

.vip-toast.show .vip-toast-bar {
  animation: vipBarDrain 3.5s linear forwards;
  animation-delay: 0.3s;
}

@keyframes vipBarDrain {
  from { transform: scaleX(1); }
  to   { transform: scaleX(0); }
}

::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: #111; }
::-webkit-scrollbar-thumb { background: var(--stone-dark); border: 2px solid #000; }
</style>
</head>
<body>

<div class="topbar">
  <div class="topbar-brand">‚õè SHADOWSHOP POS</div>
  <div class="topbar-info">
    <span id="clock">--:--</span>
    <span>Register <strong>#01</strong></span>
    <div class="cashier-badge" id="cashierBadge">üßë SHADOW</div>
  </div>
</div>

<div class="main">

  <!-- PRODUCTS -->
  <div class="products-panel">
    <div class="search-bar">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      <input type="text" id="searchInput" placeholder="Search items or SKU..." oninput="filterProducts()">
    </div>
    <div class="category-tabs" id="categoryTabs"></div>
    <div class="product-grid" id="productGrid"></div>
  </div>

  <!-- CART -->
  <div class="cart-panel">
    <div class="cart-header">
      <div class="cart-title">‚öî CART</div>
      <div class="cart-count" id="cartCount">0</div>
    </div>

    <div class="customer-row">
      <input class="mc-input" id="playerNameInput" type="text" placeholder="Player name (REQUIRED) *" oninput="onPlayerNameChange()">
      <div style="font-size:13px;color:var(--redstone);margin-top:4px;min-height:16px;" id="playerNameError"></div>
    </div>

    <div class="cart-items" id="cartItems">
      <div class="cart-empty" id="cartEmpty">
        <div class="cart-empty-icon">üì¶</div>
        <p>INVENTORY<br>EMPTY</p>
      </div>
    </div>

    <div class="discount-row">
      <input class="discount-input" type="text" id="discountInput" placeholder="Discount code...">
      <button class="btn-discount" onclick="applyDiscount()">APPLY</button>
    </div>

    <div class="cart-totals">
      <div class="totals-row"><span>Subtotal</span><span id="subtotalDisplay">‚óà 0</span></div>
      <div class="totals-row discount" id="discountRow" style="display:none"><span id="discountLabel">Discount</span><span id="discountDisplay">-‚óà 0</span></div>
      <div class="totals-row"><span>Service Fee</span><span id="feesDisplay">‚óà 0</span></div>
      <hr class="totals-divider">
      <div class="totals-row total"><span>TOTAL</span><span id="totalDisplay">‚óà 0</span></div>
    </div>

    <div class="pay-section">
      <button class="btn-charge" id="chargeBtn" onclick="goToCharge()" disabled>
        CHARGE ‚óà 0
      </button>
    </div>
  </div>

</div>

<div class="toast" id="toast"></div>

<div class="vip-toast" id="vipToast">
  <div class="vip-toast-icon">üëë</div>
  <div class="vip-toast-body">
    <div class="vip-toast-title">‚òÖ VIP CUSTOMER ‚òÖ</div>
    <div class="vip-toast-msg">DISCOUNT APPLIED!<br>50% OFF YOUR ORDER</div>
    <div class="vip-toast-bar"></div>
  </div>
</div>

<script>
// Guard: redirect to login if not logged in
if (sessionStorage.getItem('ss_loggedIn') !== '1') {
  window.location.href = 'login.html';
}

// Set cashier name
const cashierName = sessionStorage.getItem('ss_cashier') || 'Shadow';
document.getElementById('cashierBadge').textContent = 'üßë ' + cashierName.toUpperCase();

// ===== DATA =====
const PRODUCTS = [
  { id:1,  name:'Enchanted Armor', sku:'SJH@12',  price:7,   emoji:'üõ°Ô∏è', category:'Armor' },
  { id:2,  name:'Single Enchanted',sku:'SJH@15',  price:2,   emoji:'‚ú®',  category:'Armor' },
  { id:3,  name:'Armor',           sku:'WHS@83',  price:5,   emoji:'‚öîÔ∏è', category:'Armor' },
  { id:9,  name:'Single Armor',    sku:'WHS@475', price:2,   emoji:'ü™ñ', category:'Armor' },
  { id:4,  name:'Blocks',          sku:'DH@34',   price:1,   emoji:'üü´', category:'Blocks' },
  { id:5,  name:'Blocks2',         sku:'DH@67',   price:2,   emoji:'üü©', category:'Blocks' },
  { id:6,  name:'Redstone',        sku:'RH@10',   price:3,   emoji:'üî¥', category:'Resources' },
  { id:11, name:'Fuel',            sku:'OIL@3117',price:67,  emoji:'‚õΩ', category:'Resources' },
  { id:7,  name:'House',           sku:'WHS@283', price:43,  emoji:'üè†', category:'Structures' },
  { id:8,  name:'Car',             sku:'DJW@73',  price:50,  emoji:'üöó', category:'Structures' },
  { id:10, name:'VIP Package',     sku:'VIP@124', price:100, emoji:'üëë', category:'VIP' },
];

const CATEGORIES = ['All', 'Armor', 'Blocks', 'Resources', 'Structures', 'VIP'];
const VIP_USERS = ['cgcgplayzyt', 'd4rkh00d'];
const DISCOUNT_CODES = {
  'FREE':              { type:'flat', value: 2 },
  'SECRETPASSWORD123': { type:'flat', value: 5 },
  '163926':            { type:'pct',  value: 100 },
  'VIP2736192':        { type:'pct',  value: 50 },
  'VIP37439274':       { type:'pct',  value: 50 },
};

let cart = [];
let activeCategory = 'All';
let appliedDiscount = null;

// Restore cart from session if returning from charge page
try {
  const saved = sessionStorage.getItem('ss_cart');
  if (saved) cart = JSON.parse(saved);
  const savedDisc = sessionStorage.getItem('ss_discount');
  if (savedDisc) appliedDiscount = JSON.parse(savedDisc);
  const savedPlayer = sessionStorage.getItem('ss_player');
  if (savedPlayer) {
    document.getElementById('playerNameInput').value = savedPlayer;
    // Re-trigger VIP state visually if applicable
    const nm = savedPlayer.toLowerCase();
    if (VIP_USERS.includes(nm) && appliedDiscount && appliedDiscount.code === 'VIP') {
      document.getElementById('discountInput').value = 'VIP (AUTO)';
      document.getElementById('discountInput').style.borderColor = 'var(--gold)';
      const errEl = document.getElementById('playerNameError');
      errEl.textContent = '‚òÖ VIP DISCOUNT AUTO-APPLIED!';
      errEl.style.color = 'var(--gold)';
    } else if (appliedDiscount) {
      document.getElementById('discountInput').value = appliedDiscount.code;
    }
  }
} catch(e) {}

// ===== CLOCK =====
function startClock() {
  function tick() {
    const now = new Date();
    document.getElementById('clock').textContent =
      now.toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit' });
  }
  tick();
  setInterval(tick, 1000);
}
startClock();

// ===== TABS =====
function renderTabs() {
  document.getElementById('categoryTabs').innerHTML = CATEGORIES.map(c =>
    '<button class="tab' + (c===activeCategory?' active':'') + '" onclick="setCategory(\'' + c + '\')">' + c + '</button>'
  ).join('');
}

function setCategory(cat) {
  activeCategory = cat;
  renderTabs();
  renderProducts();
}

// ===== PRODUCTS =====
function renderProducts() {
  const search = document.getElementById('searchInput').value.toLowerCase();
  const prods = PRODUCTS.filter(p => {
    const matchCat = activeCategory === 'All' || p.category === activeCategory;
    const matchSearch = !search || p.name.toLowerCase().includes(search) || p.sku.toLowerCase().includes(search);
    return matchCat && matchSearch;
  });
  document.getElementById('productGrid').innerHTML = prods.map(p =>
    '<div class="product-card" onclick="addToCart(' + p.id + ')">' +
      '<div class="product-emoji">' + p.emoji + '</div>' +
      '<div class="product-name">' + p.name + '</div>' +
      '<div class="product-sku">' + p.sku + '</div>' +
      '<div class="product-price">‚óà ' + p.price + '</div>' +
    '</div>'
  ).join('');
}

function filterProducts() { renderProducts(); }

// ===== CART =====
function addToCart(id) {
  const prod = PRODUCTS.find(p => p.id === id);
  if (!prod) return;
  const existing = cart.find(i => i.id === id);
  if (existing) existing.qty++;
  else cart.push(Object.assign({}, prod, { qty: 1 }));
  renderCart();
  showToast('Added ' + prod.name + '!');
}

function changeQty(id, delta) {
  const item = cart.find(i => i.id === id);
  if (!item) return;
  item.qty += delta;
  if (item.qty <= 0) cart = cart.filter(i => i.id !== id);
  renderCart();
}

function removeItem(id) {
  cart = cart.filter(i => i.id !== id);
  renderCart();
}

function renderCart() {
  const el = document.getElementById('cartItems');
  const empty = document.getElementById('cartEmpty');

  if (cart.length === 0) {
    el.innerHTML = '';
    el.appendChild(empty);
    empty.style.display = 'flex';
  } else {
    empty.style.display = 'none';
    el.innerHTML = cart.map(item =>
      '<div class="cart-item">' +
        '<div class="cart-item-emoji">' + item.emoji + '</div>' +
        '<div class="cart-item-info">' +
          '<div class="cart-item-name">' + item.name + '</div>' +
          '<div class="cart-item-price">‚óà ' + item.price + ' each</div>' +
        '</div>' +
        '<div class="cart-item-controls">' +
          '<button class="qty-btn" onclick="changeQty(' + item.id + ',-1)">‚àí</button>' +
          '<span class="qty-display">' + item.qty + '</span>' +
          '<button class="qty-btn" onclick="changeQty(' + item.id + ',1)">+</button>' +
        '</div>' +
        '<div class="cart-item-total">‚óà ' + (item.price * item.qty) + '</div>' +
        '<button class="remove-btn" onclick="removeItem(' + item.id + ')">‚úï</button>' +
      '</div>'
    ).join('');
    el.appendChild(empty);
  }

  document.getElementById('cartCount').textContent = cart.reduce((s,i) => s+i.qty, 0);
  updateTotals();
}

// ===== TOTALS =====
function getSubtotal() {
  return cart.reduce((s,i) => s + i.price * i.qty, 0);
}

function getDiscountAmt(subtotal) {
  if (!appliedDiscount) return 0;
  if (appliedDiscount.type === 'pct') return Math.round(subtotal * appliedDiscount.value / 100);
  return Math.min(appliedDiscount.value, subtotal);
}

function isOwnerCode() {
  return appliedDiscount && appliedDiscount.code === '163926';
}

function getTotal() {
  const subtotal = getSubtotal();
  const discAmt = getDiscountAmt(subtotal);
  const fees = (cart.length > 0 && !isOwnerCode()) ? 1 : 0;
  return subtotal - discAmt + fees;
}

function updateTotals() {
  const subtotal = getSubtotal();
  const discAmt = getDiscountAmt(subtotal);
  const fees = (cart.length > 0 && !isOwnerCode()) ? 1 : 0;
  const total = subtotal - discAmt + fees;

  document.getElementById('subtotalDisplay').textContent = '‚óà ' + subtotal;

  const feesEl = document.getElementById('feesDisplay');
  feesEl.textContent = '‚óà ' + fees;
  if (isOwnerCode()) {
    feesEl.style.textDecoration = 'line-through';
    feesEl.style.color = 'var(--emerald)';
  } else {
    feesEl.style.textDecoration = '';
    feesEl.style.color = '';
  }

  document.getElementById('totalDisplay').textContent = '‚óà ' + total;

  if (appliedDiscount && (discAmt > 0 || isOwnerCode())) {
    document.getElementById('discountRow').style.display = 'flex';
    const lbl = appliedDiscount.type === 'pct'
      ? 'Discount (' + appliedDiscount.value + '%)'
      : 'Discount (' + appliedDiscount.code + ')';
    document.getElementById('discountLabel').textContent = lbl;
    document.getElementById('discountDisplay').textContent = '-‚óà ' + discAmt;
  } else {
    document.getElementById('discountRow').style.display = 'none';
  }

  const btn = document.getElementById('chargeBtn');
  btn.textContent = isOwnerCode() && total === 0 ? 'CHARGE FREE ‚úì' : 'CHARGE ‚óà ' + total;
  btn.disabled = cart.length === 0;
}

function applyDiscount() {
  const code = document.getElementById('discountInput').value.trim().toUpperCase();
  const discEl = document.getElementById('discountInput');
  const disc = DISCOUNT_CODES[code];

  if (disc) {
    appliedDiscount = Object.assign({}, disc, { code });
    discEl.style.borderColor = 'var(--emerald)';
    showToast('Code applied: ' + code + '!');
    setTimeout(() => discEl.style.borderColor = '', 2000);
  } else {
    appliedDiscount = null;
    discEl.style.borderColor = 'var(--redstone)';
    showToast('Invalid code!');
    setTimeout(() => discEl.style.borderColor = '', 2000);
  }
  updateTotals();
}

// ===== PLAYER NAME =====
function onPlayerNameChange() {
  const el = document.getElementById('playerNameInput');
  const errEl = document.getElementById('playerNameError');
  const name = el.value.trim().toLowerCase();

  el.style.borderColor = name ? 'var(--emerald)' : '';
  errEl.textContent = '';

  if (VIP_USERS.includes(name)) {
    appliedDiscount = { type:'pct', value: 50, code: 'VIP' };
    document.getElementById('discountInput').value = 'VIP (AUTO)';
    document.getElementById('discountInput').style.borderColor = 'var(--gold)';
    errEl.textContent = '‚òÖ VIP DISCOUNT AUTO-APPLIED!';
    errEl.style.color = 'var(--gold)';
    showVipToast();
  } else {
    if (appliedDiscount && appliedDiscount.code === 'VIP') {
      appliedDiscount = null;
      document.getElementById('discountInput').value = '';
      document.getElementById('discountInput').style.borderColor = '';
    }
    errEl.style.color = 'var(--redstone)';
  }
  updateTotals();
}

// ===== NAVIGATE TO CHARGE =====
function goToCharge() {
  if (cart.length === 0) return;
  const playerName = document.getElementById('playerNameInput').value.trim();
  if (!playerName) {
    document.getElementById('playerNameError').textContent = '‚úó PLAYER NAME REQUIRED!';
    document.getElementById('playerNameInput').style.borderColor = 'var(--redstone)';
    showToast('Enter a player name first!');
    return;
  }
  // Save state to sessionStorage
  sessionStorage.setItem('ss_cart', JSON.stringify(cart));
  sessionStorage.setItem('ss_discount', JSON.stringify(appliedDiscount));
  sessionStorage.setItem('ss_player', playerName);
  sessionStorage.setItem('ss_total', getTotal());
  window.location.href = 'charge.html';
}

// ===== VIP TOAST =====
let vipToastTimer = null;
function showVipToast() {
  const el = document.getElementById('vipToast');
  const bar = el.querySelector('.vip-toast-bar');
  const newBar = bar.cloneNode(true);
  bar.parentNode.replaceChild(newBar, bar);
  el.classList.remove('show');
  void el.offsetWidth;
  el.classList.add('show');
  if (vipToastTimer) clearTimeout(vipToastTimer);
  vipToastTimer = setTimeout(() => el.classList.remove('show'), 4000);
}

// ===== TOAST =====
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 1800);
}

// ===== INIT =====
renderTabs();
renderProducts();
renderCart();
</script>
</body>
</html>
